(function(){"use strict";function t(){n.add("toc",function(t){C(t),$(t),b(t)})}var n=tinymce.util.Tools.resolve("tinymce.PluginReceptionist"),e=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),o=tinymce.util.Tools.resolve("tinymce.util.I18n"),r=tinymce.util.Tools.resolve("tinymce.util.Tools"),i=function(t){return t.getParam("toc_class","mce-toc")},c=function(t){var n=t.getParam("toc_header","h2");return/^h[1-6]$/.test(n)?n:"h2"},l=function(t){var n=parseInt(t.getParam("toc_depth","3"),10);return n>=1&&n<=9?n:3},a=function(t){var n=0;return function(){var e=(new Date).getTime().toString(32);return t+e+(n++).toString(32)}},u=a("mcetoc_"),d=function(t){var n,e=[];for(n=1;n<=t;n++)e.push("h"+n);return e.join(",")},f=function(t){return s(t).length>0},s=function(t){var n=i(t),e=c(t),o=d(l(t)),a=t.$(o);return a.length&&/^h[1-9]$/i.test(e)&&(a=a.filter(function(e,o){return!t.dom.hasClass(o.parentNode,n)})),r.map(a,function(n){var e=n.id;return{id:e||u(),level:parseInt(n.nodeName.replace(/^H/i,""),10),title:t.$.text(n),element:n}})},m=function(t){for(var n=9,e=0;e<t.length;e++)if(t[e].level<n&&(n=t[e].level),1===n)return n;return n},v=function(t,n){var o="<"+t+' contenteditable="true">',r="</"+t+">";return o+e.DOM.encode(n)+r},g=function(t){var n=h(t);return'<div class="'+t.dom.encode(i(t))+'" contenteditable="false">'+n+"</div>"},h=function(t){var n="",e=s(t),r=m(e)-1;if(!e.length)return"";n+=v(c(t),o.translate("Table of Contents"));for(var i=0;i<e.length;i++){var l=e[i];l.element.id=l.id;var a=e[i+1]&&e[i+1].level;if(r===l.level)n+="<li>";else for(var u=r;u<l.level;u++)n+="<ul><li>";if(n+='<a href="#'+l.id+'">'+l.title+"</a>",a!==l.level&&a)for(u=l.level;u>a;u--)n+=u===a+1?"</li></ul><li>":"</li></ul>";else n+="</li>",a||(n+="</ul>");r=l.level}return n},p=function(t,n){return!n.length||t.dom.getParents(n[0],".mce-offscreen-selection").length>0},y=function(t){var n=i(t),e=t.$("."+n);p(t,e)?t.insertContent(g(t)):T(t)},T=function(t){var n=i(t),e=t.$("."+n);e.length&&t.undoReceptionist.transact(function(){e.html(h(t))})},C=function(t){t.addCommand("mceInsertToc",function(){y(t)}),t.addCommand("mceUpdateToc",function(){T(t)})},b=function(t){var n=t.$,e=i(t);t.on("PreProcess",function(t){var o=n("."+e,t.node);o.length&&(o.removeAttr("contentEditable"),o.find("[contenteditable]").removeAttr("contentEditable"))}),t.on("SetContent",function(){var t=n("."+e);t.length&&(t.attr("contentEditable",!1),t.children(":first-child").attr("contentEditable",!0))})},P=function(t){return function(n){var e=function(){return n.setDisabled(t.mode.isReadOnly()||!f(t))};return e(),t.on("LoadContent SetContent change",e),function(){return t.on("LoadContent SetContent change",e)}}},S=function(t){return function(n){return n&&t.dom.is(n,"."+i(t))&&t.getBody().contains(n)}},$=function(t){var n=function(){return t.execCommand("mceInsertToc")};t.ui.registry.addButton("toc",{icon:"toc",tooltip:"Table of contents",onAction:n,onSetup:P(t)}),t.ui.registry.addButton("tocupdate",{icon:"reload",tooltip:"Update",onAction:function(){return t.execCommand("mceUpdateToc")}}),t.ui.registry.addMenuItem("toc",{icon:"toc",text:"Table of contents",onAction:n,onSetup:P(t)}),t.ui.registry.addContextToolbar("toc",{items:"tocupdate",predicate:S(t),scope:"node",position:"node"})};t()})();