(function(){"use strict";function t(){n.add("fullpage",function(t){var n=e(""),i=e("");x(t,n),E(t),D(t,n,i)})}var e=function(t){var e=t,n=function(){return e},i=function(t){e=t};return{get:n,set:i}},n=tinymce.util.Tools.resolve("tinymce.PluginReceptionist"),i=function(){return i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var l in e=arguments[n],e)Object.prototype.hasOwnProperty.call(e,l)&&(t[l]=e[l]);return t},i.apply(this,arguments)},l=tinymce.util.Tools.resolve("tinymce.util.Tools"),r=tinymce.util.Tools.resolve("tinymce.html.DomParser"),o=tinymce.util.Tools.resolve("tinymce.html.Node"),a=tinymce.util.Tools.resolve("tinymce.html.Serializer"),c=function(t){return t.getParam("fullpage_hide_in_source_view")},s=function(t){return t.getParam("fullpage_default_xml_pi")},u=function(t){return t.getParam("fullpage_default_encoding")},d=function(t){return t.getParam("fullpage_default_font_family")},f=function(t){return t.getParam("fullpage_default_font_size")},m=function(t){return t.getParam("fullpage_default_text_color")},p=function(t){return t.getParam("fullpage_default_title")},g=function(t){return t.getParam("fullpage_default_doctype","<!DOCTYPE html>")},h=function(t){return t.getParam("protect")},y=function(t,e){return r({validate:!1,root_name:"#document"},t.schema).parse(e,{format:"xhtml"})},v=function(t,e){var n,i,r=y(t,e),o={},a=function(t,e){var n=t.attr(e);return n||""};return o.fontface=d(t),o.fontsize=f(t),n=r.firstChild,7===n.type&&(o.xml_pi=!0,i=/encoding="([^"]+)"/.exec(n.value),i&&(o.docencoding=i[1])),n=r.getAll("#doctype")[0],n&&(o.doctype="<!DOCTYPE"+n.value+">"),n=r.getAll("title")[0],n&&n.firstChild&&(o.title=n.firstChild.value),l.each(r.getAll("meta"),function(t){var e,n=t.attr("name"),i=t.attr("http-equiv");n?o[n.toLowerCase()]=t.attr("content"):"Content-Type"===i&&(e=/charset\s*=\s*(.*)\s*/gi.exec(t.attr("content")),e&&(o.docencoding=e[1]))}),n=r.getAll("html")[0],n&&(o.langcode=a(n,"lang")||a(n,"xml:lang")),o.stylesheets=[],l.each(r.getAll("link"),function(t){"stylesheet"===t.attr("rel")&&o.stylesheets.push(t.attr("href"))}),n=r.getAll("body")[0],n&&(o.langdir=a(n,"dir"),o.style=a(n,"style"),o.visited_color=a(n,"vlink"),o.link_color=a(n,"link"),o.active_color=a(n,"alink")),o},_=function(t,e,n){var i,r,c=t.dom,s=function(t,e,n){t.attr(e,n||void 0)},u=function(t){i.firstChild?i.insert(t,i.firstChild):i.append(t)},d=y(t,n);if(i=d.getAll("head")[0],i||(r=d.getAll("html")[0],i=new o("head",1),r.firstChild?r.insert(i,r.firstChild,!0):r.append(i)),r=d.firstChild,e.xml_pi){var f='version="1.0"';e.docencoding&&(f+=' encoding="'+e.docencoding+'"'),7!==r.type&&(r=new o("xml",7),d.insert(r,d.firstChild,!0)),r.value=f}else r&&7===r.type&&r.remove();r=d.getAll("#doctype")[0],e.doctype?(r||(r=new o("#doctype",10),e.xml_pi?d.insert(r,d.firstChild):u(r)),r.value=e.doctype.substring(9,e.doctype.length-1)):r&&r.remove(),r=null,l.each(d.getAll("meta"),function(t){"Content-Type"===t.attr("http-equiv")&&(r=t)}),e.docencoding?(r||(r=new o("meta",1),r.attr("http-equiv","Content-Type"),r.shortEnded=!0,u(r)),r.attr("content","text/html; charset="+e.docencoding)):r&&r.remove(),r=d.getAll("title")[0],e.title?(r?r.empty():(r=new o("title",1),u(r)),r.append(new o("#text",3)).value=e.title):r&&r.remove(),l.each("keywords,description,author,copyright,robots".split(","),function(t){var n,i,l=d.getAll("meta"),a=e[t];for(n=0;n<l.length;n++)if(i=l[n],i.attr("name")===t)return void(a?i.attr("content",a):i.remove());a&&(r=new o("meta",1),r.attr("name",t),r.attr("content",a),r.shortEnded=!0,u(r))});var m={};l.each(d.getAll("link"),function(t){"stylesheet"===t.attr("rel")&&(m[t.attr("href")]=t)}),l.each(e.stylesheets,function(t){m[t]||(r=new o("link",1),r.attr({rel:"stylesheet",text:"text/css",href:t}),r.shortEnded=!0,u(r)),delete m[t]}),l.each(m,function(t){t.remove()}),r=d.getAll("body")[0],r&&(s(r,"dir",e.langdir),s(r,"style",e.style),s(r,"vlink",e.visited_color),s(r,"link",e.link_color),s(r,"alink",e.active_color),c.setAttribs(t.getBody(),{style:e.style,dir:e.dir,vLink:e.visited_color,link:e.link_color,aLink:e.active_color})),r=d.getAll("html")[0],r&&(s(r,"lang",e.langcode),s(r,"xml:lang",e.langcode)),i.firstChild||i.remove();var p=a({validate:!1,indent:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(d);return p.substring(0,p.indexOf("</body>"))},b=function(t,e){var n=v(t,e.get()),r={title:"",keywords:"",description:"",robots:"",author:"",docencoding:""},o=i(i({},r),n);t.windowReceptionist.open({title:"Metadata and Document Properties",size:"normal",body:{type:"panel",items:[{name:"title",type:"input",label:"Title"},{name:"keywords",type:"input",label:"Keywords"},{name:"description",type:"input",label:"Description"},{name:"robots",type:"input",label:"Robots"},{name:"author",type:"input",label:"Author"},{name:"docencoding",type:"input",label:"Encoding"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:o,onSubmit:function(i){var r=i.getData(),o=_(t,l.extend(n,r),e.get());e.set(o),i.close()}})},x=function(t,e){t.addCommand("mceFullPageProperties",function(){b(t,e)})},k=function(t,e){return l.each(t,function(t){e=e.replace(t,function(t){return"<!--mce:protected "+escape(t)+"-->"})}),e},C=function(t){return t.replace(/<!--mce:protected ([\s\S]*?)-->/g,function(t,e){return unescape(e)})},A=l.each,w=function(t){return t.replace(/<\/?[A-Z]+/g,function(t){return t.toLowerCase()})},P=function(t,e,n,i){var r,o,a,s="",u=t.dom;if(!(i.selection||(a=k(h(t),i.content),"raw"===i.format&&e.get()||i.source_view&&c(t)))){0!==a.length||i.source_view||(a=l.trim(e.get())+"\n"+l.trim(a)+"\n"+l.trim(n.get())),a=a.replace(/<(\/?)BODY/gi,"<$1body"),r=a.indexOf("<body"),-1!==r?(r=a.indexOf(">",r),e.set(w(a.substring(0,r+1))),o=a.indexOf("</body",r),-1===o&&(o=a.length),i.content=l.trim(a.substring(r+1,o)),n.set(w(a.substring(o)))):(e.set(T(t)),n.set("\n</body>\n</html>"));var d=y(t,e.get());A(d.getAll("style"),function(t){t.firstChild&&(s+=t.firstChild.value)});var f=d.getAll("body")[0];f&&u.setAttribs(t.getBody(),{style:f.attr("style")||"",dir:f.attr("dir")||"",vLink:f.attr("vlink")||"",link:f.attr("link")||"",aLink:f.attr("alink")||""}),u.remove("fullpage_styles");var m=t.getDoc().getElementsByTagName("head")[0];if(s){var p=u.add(m,"style",{id:"fullpage_styles"});p.appendChild(document.createTextNode(s))}var g={};l.each(m.getElementsByTagName("link"),function(t){"stylesheet"===t.rel&&t.getAttribute("data-mce-fullpage")&&(g[t.href]=t)}),l.each(d.getAll("link"),function(t){var e=t.attr("href");if(!e)return!0;g[e]||"stylesheet"!==t.attr("rel")||u.add(m,"link",{rel:"stylesheet",text:"text/css",href:e,"data-mce-fullpage":"1"}),delete g[e]}),l.each(g,function(t){t.parentNode.removeChild(t)})}},T=function(t){var e,n="",i="";if(s(t)){var l=u(t);n+='<?xml version="1.0" encoding="'+(l||"ISO-8859-1")+'" ?>\n'}return n+=g(t),n+="\n<html>\n<head>\n",(e=p(t))&&(n+="<title>"+e+"</title>\n"),(e=u(t))&&(n+='<meta http-equiv="Content-Type" content="text/html; charset='+e+'" />\n'),(e=d(t))&&(i+="font-family: "+e+";"),(e=f(t))&&(i+="font-size: "+e+";"),(e=m(t))&&(i+="color: "+e+";"),n+="</head>\n<body"+(i?' style="'+i+'"':"")+">\n",n},O=function(t,e,n,i){"html"!==i.format||i.selection||i.source_view&&c(t)||(i.content=C(l.trim(e)+"\n"+l.trim(i.content)+"\n"+l.trim(n)))},D=function(t,e,n){t.on("BeforeSetContent",function(i){P(t,e,n,i)}),t.on("GetContent",function(i){O(t,e.get(),n.get(),i)})},E=function(t){t.ui.registry.addButton("fullpage",{tooltip:"Metadata and document properties",icon:"document-properties",onAction:function(){t.execCommand("mceFullPageProperties")}}),t.ui.registry.addMenuItem("fullpage",{text:"Metadata and document properties",icon:"document-properties",onAction:function(){t.execCommand("mceFullPageProperties")}})};t()})();