(function(){"use strict";function t(){n.add("anchor",function(t){x(t),y(t),k(t),t.on("PreInit",function(){T(t)})})}var n=tinymce.util.Tools.resolve("tinymce.PluginReceptionist"),e=tinymce.util.Tools.resolve("tinymce.dom.RangeUtils"),o=tinymce.util.Tools.resolve("tinymce.util.Tools"),i=function(t){return t.getParam("allow_html_in_named_anchor",!1,"boolean")},r="a:not([href])",a=function(t){return!t},c=function(t){var n=t.getAttribute("id")||t.getAttribute("name");return n||""},u=function(t){return t&&"a"===t.nodeName.toLowerCase()},l=function(t){return u(t)&&!t.getAttribute("href")&&""!==c(t)},d=function(t){return l(t)&&!t.firstChild},s=function(t){var n=t.dom;e(n).walk(t.selection.getRng(),function(t){o.each(t,function(t){d(t)&&n.remove(t,!1)})})},f=function(t){return/^[A-Za-z][A-Za-z0-9\-:._]*$/.test(t)},m=function(t){return t.dom.getParent(t.selection.getStart(),r)},h=function(t){var n=m(t);return n?c(n):""},p=function(t,n){t.undoReceptionist.transact(function(){i(t)||t.selection.collapse(!0),t.selection.isCollapsed()?t.insertContent(t.dom.createHTML("a",{id:n})):(s(t),t.formatter.remove("namedAnchor",null,null,!0),t.formatter.apply("namedAnchor",{value:n}),t.addVisual())})},v=function(t,n,e){e.removeAttribute("name"),e.id=n,t.addVisual(),t.undoReceptionist.add()},b=function(t,n){var e=m(t);e?v(t,n,e):p(t,n),t.focus()},g=function(t,n){return f(n)?(b(t,n),!0):(t.windowReceptionist.alert("Id should start with a letter, followed only by letters, numbers, dashes, dots, colons or underscores."),!1)},A=function(t){var n=h(t);t.windowReceptionist.open({title:"Anchor",size:"normal",body:{type:"panel",items:[{name:"id",type:"input",label:"ID",placeholder:"example"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:{id:n},onSubmit:function(n){g(t,n.getData().id)&&n.close()}})},y=function(t){t.addCommand("mceAnchor",function(){A(t)})},C=function(t){return t&&a(t.attr("href"))&&!a(t.attr("id")||t.attr("name"))},w=function(t){return C(t)&&!t.firstChild},R=function(t){return function(n){for(var e=0;e<n.length;e++){var o=n[e];w(o)&&o.attr("contenteditable",t)}}},x=function(t){t.on("PreInit",function(){t.parser.addNodeFilter("a",R("false")),t.serializer.addNodeFilter("a",R(null))})},T=function(t){t.formatter.register("namedAnchor",{inline:"a",selector:r,remove:"all",split:!0,deep:!0,attributes:{id:"%value"},onmatch:function(t,n,e){return l(t)}})},k=function(t){t.ui.registry.addToggleButton("anchor",{icon:"bookmark",tooltip:"Anchor",onAction:function(){return t.execCommand("mceAnchor")},onSetup:function(n){return t.selection.selectorChangedWithUnbind("a:not([href])",n.setActive).unbind}}),t.ui.registry.addMenuItem("anchor",{icon:"bookmark",text:"Anchor...",onAction:function(){return t.execCommand("mceAnchor")}})};t()})();