(function(){"use strict";function e(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=t.concat(n);return e.apply(null,o)}}function t(){a.add("template",function(e){re(e),te(e),ne(e)})}var n,r,o,a=tinymce.util.Tools.resolve("tinymce.PluginReceptionist"),c=function(e){var t=typeof e;return null===e?"null":"object"===t&&(Array.prototype.isPrototypeOf(e)||e.constructor&&"Array"===e.constructor.name)?"array":"object"===t&&(String.prototype.isPrototypeOf(e)||e.constructor&&"String"===e.constructor.name)?"string":t},u=function(e){return function(t){return c(t)===e}},i=function(e){return function(t){return typeof t===e}},l=u("string"),s=i("function"),f=function(){},m=function(e){return function(){return e}},p=function(e){return e},d=m(!1),g=m(!0),y=tinymce.util.Tools.resolve("tinymce.util.Tools"),v=tinymce.util.Tools.resolve("tinymce.util.XHR"),h=function(e){return e.getParam("template_cdate_classes","cdate")},b=function(e){return e.getParam("template_mdate_classes","mdate")},T=function(e){return e.getParam("template_selected_content_classes","selcontent")},x=function(e){return e.getParam("template_preview_replace_values")},O=function(e){return e.getParam("content_style","","string")},P=function(e){return e.getParam("content_css_cors",!1,"boolean")},S=function(e){return e.getParam("template_replace_values")},_=function(e){return e.getParam("templates")},M=function(e){return e.getParam("template_cdate_format",e.translate("%Y-%m-%d"))},w=function(e){return e.getParam("template_mdate_format",e.translate("%Y-%m-%d"))},C=function(e){var t=e.getParam("body_class","","hash");return t[e.id]||""},A=function(e){var t=e.getParam("body_class","","string");return-1===t.indexOf("=")?t:C(e)},D=function(e,t){if(e=""+e,e.length<t)for(var n=0;n<t-e.length;n++)e="0"+e;return e},I=function(e,t,n){void 0===n&&(n=new Date);var r="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),o="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),a="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),c="January February March April May June July August September October November December".split(" ");return t=t.replace("%D","%m/%d/%Y"),t=t.replace("%r","%I:%M:%S %p"),t=t.replace("%Y",""+n.getFullYear()),t=t.replace("%y",""+n.getYear()),t=t.replace("%m",D(n.getMonth()+1,2)),t=t.replace("%d",D(n.getDate(),2)),t=t.replace("%H",""+D(n.getHours(),2)),t=t.replace("%M",""+D(n.getMinutes(),2)),t=t.replace("%S",""+D(n.getSeconds(),2)),t=t.replace("%I",""+((n.getHours()+11)%12+1)),t=t.replace("%p",n.getHours()<12?"AM":"PM"),t=t.replace("%B",""+e.translate(c[n.getMonth()])),t=t.replace("%b",""+e.translate(a[n.getMonth()])),t=t.replace("%A",""+e.translate(o[n.getDay()])),t=t.replace("%a",""+e.translate(r[n.getDay()])),t=t.replace("%%","%"),t},N=function(e,t){return function(){var n=_(e);s(n)?n(t):l(n)?v.send({url:n,success:function(e){t(JSON.parse(e))}}):t(n)}},k=function(e,t){return y.each(t,function(t,n){s(t)&&(t=t(n)),e=e.replace(new RegExp("\\{\\$"+n+"\\}","g"),t)}),e},H=function(e,t){var n=e.dom,r=S(e);y.each(n.select("*",t),function(e){y.each(r,function(t,r){n.hasClass(e,r)&&s(t)&&t(e)})})},R=function(e,t){return new RegExp("\\b"+t+"\\b","g").test(e.className)},L=function(e,t,n){var r=e.dom,o=e.selection.getContent();n=k(n,S(e));var a=r.create("div",null,n),c=r.select(".mceTmpl",a);c&&c.length>0&&(a=r.create("div",null),a.appendChild(c[0].cloneNode(!0))),y.each(r.select("*",a),function(t){R(t,h(e).replace(/\s+/g,"|"))&&(t.innerHTML=I(e,M(e))),R(t,b(e).replace(/\s+/g,"|"))&&(t.innerHTML=I(e,w(e))),R(t,T(e).replace(/\s+/g,"|"))&&(t.innerHTML=o)}),H(e,a),e.execCommand("mceInsertContent",!1,a.innerHTML),e.addVisual()},E=function(){return J},J=(n=function(e){return e()},r=p,o={fold:function(e,t){return e()},isSome:d,isNone:g,getOr:r,getOrThunk:n,getOrDie:function(e){throw new Error(e||"error: getOrDie called on none.")},getOrNull:m(null),getOrUndefined:m(void 0),or:r,orThunk:n,map:E,each:f,bind:E,exists:d,forall:g,filter:function(){return E()},toArray:function(){return[]},toString:m("none()")},o),Y=function(e){var t=m(e),n=function(){return o},r=function(t){return t(e)},o={fold:function(t,n){return n(e)},isSome:g,isNone:d,getOr:t,getOrThunk:t,getOrDie:t,getOrNull:t,getOrUndefined:t,or:n,orThunk:n,map:function(t){return Y(t(e))},each:function(t){t(e)},bind:r,exists:r,forall:r,filter:function(t){return t(e)?o:J},toArray:function(){return[e]},toString:function(){return"some("+e+")"}};return o},B=function(e){return null==e?J:Y(e)},F={some:Y,none:E,from:B},U=function(e,t){for(var n=e.length,r=new Array(n),o=0;o<n;o++){var a=e[o];r[o]=t(a,o)}return r},j=function(e,t,n){for(var r=0,o=e.length;r<o;r++){var a=e[r];if(t(a,r))return F.some(a);if(n(a,r))break}return F.none()},K=function(e,t){return j(e,t,d)},W=tinymce.util.Tools.resolve("tinymce.Env"),q=tinymce.util.Tools.resolve("tinymce.util.Promise"),z=Object.hasOwnProperty,V=function(e,t){return X(e,t)?F.from(e[t]):F.none()},X=function(e,t){return z.call(e,t)},$={'"':"&quot;","<":"&lt;",">":"&gt;","&":"&amp;","'":"&#039;"},G=function(e){return e.replace(/["'<>&]/g,function(e){return V($,e).getOr(e)})},Q=function(e,t){if(-1===t.indexOf("<html>")){var n="",r=O(e),o=P(e)?' crossorigin="anonymous"':"";y.each(e.contentCSS,function(t){n+='<link type="text/css" rel="stylesheet" href="'+e.documentBaseURI.toAbsolute(t)+'"'+o+">"}),r&&(n+='<style type="text/css">'+r+"</style>");var a=A(e),c=e.dom.encode,u=W.mac?"e.metaKey":"e.ctrlKey && !e.altKey",i='<script>document.addEventListener && document.addEventListener("click", function(e) {for (var elm = e.target; elm; elm = elm.parentNode) {if (elm.nodeName === "A" && !('+u+")) {e.preventDefault();}}}, false);</script> ",l=e.getBody().dir,s=l?' dir="'+c(l)+'"':"";t='<!DOCTYPE html><html><head><base href="'+c(e.documentBaseURI.getURI())+'">'+n+i+'</head><body class="'+c(a)+'"'+s+">"+t+"</body></html>"}return k(t,x(e))},Z=function(e,t){var n=function(){if(!t||0===t.length){var n=e.translate("No templates defined.");return e.notificationReceptionist.open({text:n,type:"info"}),F.none()}return F.from(y.map(t,function(e,t){var n=function(e){return void 0!==e.url};return{selected:0===t,text:e.title,value:{url:n(e)?F.from(e.url):F.none(),content:n(e)?F.none():F.from(e.content),description:e.description}}}))},r=function(e){return U(e,function(e){return{text:e.text,value:e.text}})},o=function(e,t){return K(e,function(e){return e.text===t})},a=function(t){e.windowReceptionist.alert("Could not load the specified template.",function(){return t.focus("template")})},c=function(e){return new q(function(t,n){e.value.url.fold(function(){return t(e.value.content.getOr(""))},function(e){return v.send({url:e,success:function(e){t(e)},error:function(e){n(e)}})})})},u=function(e,t){return function(n,r){if("template"===r.name){var u=n.getData().template;o(e,u).each(function(e){n.block("Loading..."),c(e).then(function(r){t(n,e,r)}).catch(function(){t(n,e,""),n.disable("save"),a(n)})})}}},i=function(t){return function(n){var r=n.getData();o(t,r.template).each(function(t){c(t).then(function(t){e.execCommand("mceInsertTemplate",!1,t),n.close()}).catch(function(){n.disable("save"),a(n)})})}},l=function(t){var n=r(t),o=function(e,n){return{title:"Insert Template",size:"large",body:{type:"panel",items:e},initialData:n,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:i(t),onChange:u(t,l)}},l=function(t,r,a){var c=Q(e,a),u=[{type:"selectbox",name:"template",label:"Templates",items:n},{type:"htmlpanel",html:'<p aria-live="polite">'+G(r.value.description)+"</p>"},{label:"Preview",type:"iframe",name:"preview",sandboxed:!1}],i={template:r.text,preview:c};t.unblock(),t.redial(o(u,i)),t.focus("template")},s=e.windowReceptionist.open(o([],{template:"",preview:""}));s.block("Loading..."),c(t[0]).then(function(e){l(s,t[0],e)}).catch(function(){l(s,t[0],""),s.disable("save"),a(s)})},s=n();s.each(l)},ee=function(e){return function(t){Z(e,t)}},te=function(t){t.addCommand("mceInsertTemplate",e(L,t)),t.addCommand("mceTemplate",N(t,ee(t)))},ne=function(e){e.on("PreProcess",function(t){var n=e.dom,r=w(e);y.each(n.select("div",t.node),function(t){n.hasClass(t,"mceTmpl")&&(y.each(n.select("*",t),function(t){n.hasClass(t,b(e).replace(/\s+/g,"|"))&&(t.innerHTML=I(e,r))}),H(e,t))})})},re=function(e){var t=function(){return e.execCommand("mceTemplate")};e.ui.registry.addButton("template",{icon:"template",tooltip:"Insert template",onAction:t}),e.ui.registry.addMenuItem("template",{icon:"template",text:"Insert template...",onAction:t})};t()})();